<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„Ù…</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fafafa;
      color: #333;
      margin: 0; padding: 0;
    }
    header {
      background-color: #2E7D32;
      padding: 15px 20px;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header a {
      color: white;
      text-decoration: none;
      font-weight: bold;
    }
    .dark-mode {
      background-color: #121212;
      color: #ddd;
    }
    button {
      cursor: pointer;
      background-color: #6c63ff;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      color: white;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #4e47d2;
    }
    .accordion {
      max-width: 800px;
      margin: 30px auto;
      padding: 0 10px;
    }
    .accordion-item {
      background: white;
      border-radius: 6px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      border: 1px solid #ddd;
    }
    .accordion-header {
      padding: 15px 20px;
      cursor: pointer;
      font-weight: bold;
      background-color: #e8f5e9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }
    .accordion-header:hover {
      background-color: #c8e6c9;
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      padding: 0 20px;
      background: #f9f9f9;
    }
    .accordion-content.open {
      padding: 15px 20px;
      max-height: 1000px;
    }
    .course {
      margin-bottom: 15px;
      background: white;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .course h4 {
      margin: 0 0 8px 0;
    }
    .course p {
      margin: 0 0 8px 0;
      color: #555;
    }
    .course a {
      display: inline-block;
      text-decoration: none;
      background-color: #6c63ff;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
    }
    .course a:hover {
      background-color: #4e47d2;
    }
    footer {
      text-align: center;
      margin: 40px 0 20px;
      color: #666;
    }
    .loading {
      text-align: center;
      padding: 20px;
      font-weight: bold;
    }
    .error {
      color: red;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <header>
    <a href="loged.html">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <div>
      <button id="toggleDarkMode">ğŸŒ™</button>
      <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main>
    <section style="max-width: 800px; margin: 30px auto; padding: 0 10px;">
      <h1 id="welcomeMsg">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ!</h1>
      <h3 id="studentStage"></h3>
    </section>

    <div id="loadingIndicator" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª...</div>
    <div id="errorMessage" class="error" style="display: none;"></div>

    <section class="accordion" id="coursesAccordion">
      <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
    </section>
  </main>

  <footer>
    &copy; 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© | Shika & monem
  </footer>

  <script>
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ù† localStorage
    function getStudent() {
      const student = localStorage.getItem("student");
      if (!student) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
        window.location.href = "login.html";
        return null;
      }
      return JSON.parse(student);
    }

    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    function showStudentData(student) {
      const welcomeMsg = document.getElementById("welcomeMsg");
      const stage = document.getElementById("studentStage");
      welcomeMsg.textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${student.full_name || "Ø¨Ø§Ù„Ø·Ø§Ù„Ø¨"}`;
      stage.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø©: ${student.stage} - Ø§Ù„ØµÙ: ${student.grade}`;
    }

    // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    async function fetchCourses(studentCode) {
      const loadingIndicator = document.getElementById("loadingIndicator");
      const errorMessage = document.getElementById("errorMessage");
      
      try {
        loadingIndicator.style.display = "block";
        errorMessage.style.display = "none";
        
        const response = await fetch(`http://localhost:5000/student_courses/${studentCode}`);
        
        if (!response.ok) {
          throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error("ØªÙ„Ù‚ÙŠÙ†Ø§ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…");
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
        
        return data.courses_by_part || {};
        
      } catch (error) {
        console.error("Error fetching courses:", error);
        errorMessage.textContent = `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`;
        errorMessage.style.display = "block";
        return {};
      } finally {
        loadingIndicator.style.display = "none";
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙƒÙˆØ±Ø¯ÙŠÙˆÙ† Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
    function createAccordion(coursesByPart) {
    const container = document.getElementById("coursesAccordion");
    container.innerHTML = "";

    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø´Ù‡Ø± ÙƒÙ…Ø§ ÙŠØ¬Ø¨ (Ø§Ù„Ø£ÙˆÙ„ Ø«Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«)
    const monthOrder = {
        "Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„": 1,
        "Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ": 2,
        "Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù„Ø«": 3
    };

    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙˆÙØ±Ø²Ù‡Ø§ Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    const sortedMonths = Object.keys(coursesByPart)
        .filter(month => monthOrder[month])
        .sort((a, b) => monthOrder[a] - monthOrder[b]);

    if (sortedMonths.length === 0) {
        container.innerHTML = '<div class="error">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</div>';
        return;
    }

    sortedMonths.forEach(month => {
        const courses = coursesByPart[month];
        if (courses.length === 0) return;

        const item = document.createElement("div");
        item.className = "accordion-item";

        const header = document.createElement("div");
        header.className = "accordion-header";
        header.innerHTML = `
            ${month}
            <span>â–¼</span>
        `;

        const content = document.createElement("div");
        content.className = "accordion-content";

        courses.forEach(course => {
            const courseDiv = document.createElement("div");
            courseDiv.className = "course";
            courseDiv.innerHTML = `
                <h4>${course.course_name}</h4>
                ${course.description ? `<p>${course.description}</p>` : ''}
                <a href="${course.youtube_url}" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙƒÙˆØ±Ø³</a>
            `;
            content.appendChild(courseDiv);
        });

        item.appendChild(header);
        item.appendChild(content);
        container.appendChild(item);

        header.addEventListener("click", () => {
            const isOpen = content.classList.contains("open");
            document.querySelectorAll(".accordion-content").forEach(c => {
                c.classList.remove("open");
            });
            if (!isOpen) {
                content.classList.add("open");
            }
        });
    });
}
    // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    function logout() {
      localStorage.removeItem("student");
      window.location.href = "login.html";
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
    const darkModeBtn = document.getElementById("toggleDarkMode");
    darkModeBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
      if(document.body.classList.contains("dark-mode")){
        darkModeBtn.textContent = "â˜€ï¸";
      } else {
        darkModeBtn.textContent = "ğŸŒ™";
      }
    });

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.onload = async () => {
      const student = getStudent();
      if(!student) return;
      
      showStudentData(student);
      
      // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
      const coursesByPart = await fetchCourses(student.student_code);
      createAccordion(coursesByPart);
    };
  </script>
</body>
</html>