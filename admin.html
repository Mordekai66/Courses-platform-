<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ØµÙØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <style>
    body {
      font-family: Arial;
      direction: rtl;
      background-color: #f2f2f2;
      padding: 20px;
    }

    h2 {
      color: #333;
    }

    form, table {
      background-color: #fff;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }

    input, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #007bff;
      color: white;
    }
  </style>
</head>
<body>

  <h2>Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
  <form id="addStudentForm">
    <input type="text" name="student_code" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨" required>
    <input type="text" name="full_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" required>
    <select name="stage" required>
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
      <option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      <option value="Ø§Ø¹Ø¯Ø§Ø¯ÙŠ">Ø§Ø¹Ø¯Ø§Ø¯ÙŠ</option>
      <option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option>
    </select>
    <input type="number" name="age" placeholder="Ø§Ù„Ø¹Ù…Ø±" required>
    <input type="email" name="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
    <input type="text" name="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
    <input type="text" name="guardian_name" placeholder="Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" required>
    <input type="text" name="guardian_phone" placeholder="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" required>
    <button type="submit">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
  </form>

  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h2>
  <table id="studentsTable">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
        <th>Ø§Ù„Ø¹Ù…Ø±</th>
        <th>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
        <th>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
        <th>ØªØ¹Ø¯ÙŠÙ„</th>
        <th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_BASE = "http://localhost:5000";

    async function loadStudents() {
      const res = await fetch(`${API_BASE}/students`);
      const students = await res.json();
      const tbody = document.querySelector("#studentsTable tbody");
      tbody.innerHTML = "";

      students.forEach(student => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input value="${student.full_name}" onchange="updateField(${student.id}, 'full_name', this.value)"></td>
          <td>
            <select onchange="updateField(${student.id}, 'stage', this.value)">
              <option ${student.stage === 'Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ' ? 'selected' : ''}>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
              <option ${student.stage === 'Ø§Ø¹Ø¯Ø§Ø¯ÙŠ' ? 'selected' : ''}>Ø§Ø¹Ø¯Ø§Ø¯ÙŠ</option>
              <option ${student.stage === 'Ø«Ø§Ù†ÙˆÙŠ' ? 'selected' : ''}>Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </td>
          <td><input type="number" value="${student.age}" onchange="updateField(${student.id}, 'age', this.value)"></td>
          <td><input value="${student.email}" onchange="updateField(${student.id}, 'email', this.value)"></td>
          <td><input value="${student.phone}" onchange="updateField(${student.id}, 'phone', this.value)"></td>
          <td><input value="${student.guardian_name}" onchange="updateField(${student.id}, 'guardian_name', this.value)"></td>
          <td><input value="${student.guardian_phone}" onchange="updateField(${student.id}, 'guardian_phone', this.value)"></td>
          <td><button onclick="saveRow(${student.id}, this)">ğŸ’¾</button></td>
          <td><button onclick="deleteStudent(${student.id}, this)">ğŸ—‘ï¸</button></td>
        `;
        tbody.appendChild(row);
      });
    }

    const tempData = {};
    function updateField(id, key, value) {
      if (!tempData[id]) tempData[id] = {};
      tempData[id][key] = value;
    }

    async function saveRow(id, btn) {
      if (!tempData[id]) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
      btn.innerText = "â³";
      const res = await fetch(`${API_BASE}/edit_student/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(tempData[id])
      });
      btn.innerText = "ğŸ’¾";
      const data = await res.json();
      alert(data.message || data.error);
      loadStudents();
    }

    async function deleteStudent(id, btn) {
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) return;
      btn.innerText = "â³";
      const res = await fetch(`${API_BASE}/delete_student/${id}`, {
        method: "DELETE"
      });
      const data = await res.json();
      alert(data.message || data.error);
      loadStudents();
    }

    document.getElementById("addStudentForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const jsonData = {};
      formData.forEach((val, key) => jsonData[key] = val);

      const res = await fetch(`${API_BASE}/add_student`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(jsonData)
      });

      const data = await res.json();
      alert(data.message || data.error);
      e.target.reset();
      loadStudents();
    });

    loadStudents();
  </script>
</body>
</html>
